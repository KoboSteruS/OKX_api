# Руководство по диагностике "socket hang up"

## Проблема
Ошибка `socket hang up` с кодом `ECONNRESET` при подключении n8n к FastAPI серверу.

## Быстрая диагностика

### 1. Проверьте логи сервера
```bash
tail -f logs/app.log
```

### 2. Запустите сетевую диагностику
```bash
python test_network.py
```

### 3. Проверьте состояние сервера
```bash
python monitor_server.py
```

### 4. Проверьте доступность порта
```bash
telnet 109.73.192.126 8001
# или
nc -zv 109.73.192.126 8001
```

## Возможные причины и решения

### 1. Сервер перезагружается или падает
**Симптомы**: Соединение прерывается во время выполнения запроса

**Решение**:
```bash
# Перезапустите приложение
pkill -f "python.*main.py"
python -m app.main
```

### 2. Файрвол блокирует соединения
**Симптомы**: Соединение устанавливается, но сразу разрывается

**Решение**:
```bash
# Проверьте файрвол
sudo ufw status
sudo iptables -L

# Разрешите порт
sudo ufw allow 8001
```

### 3. Недостаточно ресурсов
**Симптомы**: Сервер медленно отвечает или не отвечает

**Решение**:
```bash
# Проверьте ресурсы
htop
free -h
df -h

# Перезапустите с ограничениями
python -m app.main --workers 1
```

### 4. Проблемы с таймаутами в n8n
**Симптомы**: Соединение разрывается через определенное время

**Решение**:
- Увеличьте `timeout` в n8n до 60000 (60 секунд)
- Установите `followRedirect: true`
- Добавьте `keepAlive: true`

### 5. Проблемы с сетью
**Симптомы**: Нестабильное соединение

**Решение**:
```bash
# Проверьте сеть
ping 109.73.192.126
traceroute 109.73.192.126

# Проверьте DNS
nslookup 109.73.192.126
```

## Команды для диагностики

### Проверка процессов
```bash
# Найти процесс FastAPI
ps aux | grep python

# Проверка портов
netstat -tlnp | grep 8001
lsof -i :8001
```

### Проверка логов
```bash
# Логи приложения
tail -f logs/app.log

# Системные логи
sudo journalctl -f

# Логи сети
sudo tcpdump -i any port 8001
```

### Мониторинг ресурсов
```bash
# CPU и память
htop

# Сетевые соединения
netstat -an | grep 8001

# Дисковое пространство
df -h
```

## Настройки n8n для стабильности

```javascript
{
  "method": "POST",
  "uri": "http://109.73.192.126:8001/api/v1/trade",
  "timeout": 60000,
  "followRedirect": true,
  "keepAlive": true,
  "headers": {
    "Content-Type": "application/json",
    "User-Agent": "n8n/1.0"
  },
  "body": {
    "wait_minutes": 5,
    "buy_amount": 500
  }
}
```

## Экстренные меры

### Если сервер не отвечает
```bash
# Принудительная перезагрузка
sudo reboot

# Или перезапуск только приложения
pkill -f "python.*main.py"
cd /path/to/your/app
python -m app.main
```

### Если проблема с сетью
```bash
# Перезапуск сетевого сервиса
sudo systemctl restart networking

# Проверка маршрутизации
ip route show
```

## Контакты для поддержки

При возникновении проблем:
1. Соберите логи: `tail -100 logs/app.log`
2. Запустите диагностику: `python test_network.py`
3. Проверьте состояние: `python monitor_server.py`
4. Предоставьте результаты всех команд 